# For more information about using CMake with Android Studio, read the
# documentation: https://d.android.com/studio/projects/add-native-code.html.
# For more examples on how to use CMake, see https://github.com/android/ndk-samples.

# Sets the minimum CMake version required for this project.
cmake_minimum_required(VERSION 3.22.1)

# è®¾ç½®ç¼–è¯‘é€‰é¡¹ - é’ˆå¯¹NDK 21ä¼˜åŒ–
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fPIC -O2")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fPIC -std=c++11 -O2")

# Android API çº§åˆ«æ£€æŸ¥ - æ”¯æŒAPI 21+
if("${ANDROID_PLATFORM}" STREQUAL "")
    set(ANDROID_PLATFORM "android-21")
endif()
string(REPLACE "android-" "" ANDROID_PLATFORM_LEVEL ${ANDROID_PLATFORM})
if(ANDROID_PLATFORM_LEVEL LESS 21)
    message(FATAL_ERROR "Minimum Android API level required is 21")
endif()
message(STATUS "Using Android API level: ${ANDROID_PLATFORM_LEVEL}")

# Declares the project name
project("CompileFfmpeg")

# NDKç‰ˆæœ¬æ£€æŸ¥å’Œä¼˜åŒ–
message(STATUS "NDK Version: ${ANDROID_NDK_REVISION}")
message(STATUS "Android ABI: ${ANDROID_ABI}")
message(STATUS "Android Platform: ${ANDROID_PLATFORM}")

# è®¾ç½®FFmpegè·¯å¾„
set(FFMPEG_DIR ${CMAKE_CURRENT_SOURCE_DIR}/ffmpeg/${ANDROID_ABI})
set(FFMPEG_INCLUDE_DIR ${FFMPEG_DIR}/include)
set(FFMPEG_LIB_DIR ${FFMPEG_DIR}/lib)
set(FFMPEG_SO_PATH ${FFMPEG_LIB_DIR}/libffmpeg.so)

# æ£€æŸ¥FFmpegåº“å’Œå¤´æ–‡ä»¶
message(STATUS "Looking for FFmpeg in: ${FFMPEG_DIR}")
message(STATUS "Include dir: ${FFMPEG_INCLUDE_DIR}")
message(STATUS "Lib dir: ${FFMPEG_LIB_DIR}")
message(STATUS "SO path: ${FFMPEG_SO_PATH}")

if(EXISTS ${FFMPEG_INCLUDE_DIR} AND EXISTS ${FFMPEG_SO_PATH})
    message(STATUS "âœ… Found FFmpeg in ${FFMPEG_DIR}")
    
    # æ·»åŠ å¤´æ–‡ä»¶è·¯å¾„
    include_directories(${FFMPEG_INCLUDE_DIR})
    
    # å¯¼å…¥FFmpegåº“ï¼ˆä½œä¸ºPRIVATEä¾èµ–ï¼‰
    add_library(ffmpeg SHARED IMPORTED)
    set_target_properties(ffmpeg PROPERTIES
        IMPORTED_LOCATION ${FFMPEG_SO_PATH}
        IMPORTED_SONAME "libffmpeg.so"
        INTERFACE_INCLUDE_DIRECTORIES ${FFMPEG_INCLUDE_DIR})
    
    # ç¡®ä¿FFmpegåº“è¢«åŒ…å«åœ¨APKä¸­
    set_target_properties(ffmpeg PROPERTIES
        IMPORTED_NO_SONAME TRUE)
    
    # éªŒè¯åº“æ–‡ä»¶å¤§å°ï¼ˆåŸºæœ¬å¥åº·æ£€æŸ¥ï¼‰
    file(SIZE ${FFMPEG_SO_PATH} FFMPEG_LIB_SIZE)
    if(FFMPEG_LIB_SIZE GREATER 500000)  # è‡³å°‘500KB
        message(STATUS "âœ… FFmpeg library size: ${FFMPEG_LIB_SIZE} bytes")
    set(FFMPEG_FOUND TRUE)
    else()
        message(WARNING "âŒ FFmpeg library seems too small: ${FFMPEG_LIB_SIZE} bytes")
        set(FFMPEG_FOUND FALSE)
    endif()
else()
    message(WARNING "âŒ FFmpeg not found in ${FFMPEG_DIR}")
    message(STATUS "Include dir exists: ${EXISTS ${FFMPEG_INCLUDE_DIR}}")
    message(STATUS "SO file exists: ${EXISTS ${FFMPEG_SO_PATH}}")
    set(FFMPEG_FOUND FALSE)
endif()

# åˆ›å»ºä¸»åº“ CompileFfmpeg.so
add_library(${CMAKE_PROJECT_NAME} SHARED
    ffmpeg_wrapper.cpp)

# è®¾ç½®ç¼–è¯‘å®šä¹‰
if(FFMPEG_FOUND)
    target_compile_definitions(${CMAKE_PROJECT_NAME} PRIVATE FFMPEG_FOUND=1)
else()
    target_compile_definitions(${CMAKE_PROJECT_NAME} PRIVATE FFMPEG_FOUND=0)
endif()

# è®¾ç½®ç›®æ ‡å±æ€§
set_target_properties(${CMAKE_PROJECT_NAME} PROPERTIES
    CXX_STANDARD 11
    CXX_STANDARD_REQUIRED ON)

# é“¾æ¥åº“ - æ–°çš„æ¶æ„è®¾è®¡
if(FFMPEG_FOUND)
    message(STATUS "âœ… Linking with FFmpeg and system libraries")
    target_link_libraries(${CMAKE_PROJECT_NAME} PRIVATE
        # FFmpegåº“ï¼ˆä½œä¸ºPRIVATEä¾èµ–ï¼‰
        ffmpeg
        # Androidç³»ç»Ÿåº“ï¼ˆå¤„ç†ANativeWindowç­‰ç³»ç»ŸåŠŸèƒ½ï¼‰
        android
        mediandk
        log
        z
        m
        dl
        # å…¶ä»–ç³»ç»Ÿåº“
        OpenSLES
        c++_shared  # ä¿®æ”¹ä¸º c++_shared ä»¥åŒ¹é… FFmpeg çš„ä¾èµ–
        atomic)
else()
    message(STATUS "âš ï¸  Building without FFmpeg support")
    target_link_libraries(${CMAKE_PROJECT_NAME} PRIVATE
        android
        log
        c++_shared)  # ä¿®æ”¹ä¸º c++_shared
endif()

# æ„å»ºåéªŒè¯å’Œåº“å¤åˆ¶
add_custom_command(TARGET ${CMAKE_PROJECT_NAME} POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E echo "âœ… Build completed successfully"
    COMMAND ${CMAKE_COMMAND} -E echo "ğŸ“ Output: $<TARGET_FILE:${CMAKE_PROJECT_NAME}>"
    COMMENT "Build verification"
)

# å¦‚æœæ‰¾åˆ°FFmpegï¼Œç¡®ä¿åº“æ–‡ä»¶è¢«å¤åˆ¶åˆ°è¾“å‡ºç›®å½•
if(FFMPEG_FOUND)
    add_custom_command(TARGET ${CMAKE_PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
        ${FFMPEG_SO_PATH}
        $<TARGET_FILE_DIR:${CMAKE_PROJECT_NAME}>/libffmpeg.so
        COMMENT "Copying FFmpeg library to output directory"
    )
endif()